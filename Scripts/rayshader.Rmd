---
title: "3D plotting with rayshader"
author: "Manroop Banipal, Jessica Hunter, Diego Gomez"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = "../Output/")
```

## Getting started



```{r cars}
summary(cars)
```

```{r, warning=FALSE, message=FALSE}

```


## Topographic maps

What rayshader is the most useful for, is creating stunning 3D topographic maps. Today we are going to render a map starting from an altitude raster. We are going to walk you through the process starting from a custom raster from The Santa Monica Mountains, that we previously prepared for the example.

There are many sources were you can download rasters, depending on your needs, for example [this website](https://dwtkns.com/srtm30m/) contains worldwide altitude rasters with 30 meter resolution.

Let's start by loading the required libraries. We will not be directly using functions from the libraries here listed, but these are required by rayshader in order to function correctly.

```{r pressure, warning=FALSE, message=FALSE}
library(rayshader)
library(here) #for unbreakable file paths
library(sp) #handles spatial data
library(raster) #handles raster files
library(scales) # handles with measurement scales within the map
library(rgdal) # for 3D rendering
```

Now we can import our raster as an object using the funcction raster(). We can visualize it using the function plot_map().

```{r, warning=FALSE, message=FALSE}
elevation <- raster::raster(here("Data","section_SMM.tif"))
```

Now that we have made sure our raster is loaded, let's make our 3d map!

First, we will use raster_to_matrix() to convert the raster into a 3d point matrix manageable by rayshader. We can make sure it works by plotting it with plot_map ().

```{r, warning=FALSE, message=FALSE}
height_shade(raster_to_matrix(elevation)) %>%
  plot_map()
```

Now that we have doublechecked that our raster is ready, let's crate an object with the matrix.

```{r, warning=FALSE, message=TRUE}
samo <- raster_to_matrix(elevation)
```

Now, we can render the terrain using sphere_shade(), and visualize it by piping it into the plot_3d () function. An interactive pop-up window will open, where you can move around your render, and then you can take a snapshot using the render_snapshot function().

We will use the plot_3d function to render the 3D figure, and render_snapshot() to take a screenshot after every step.

```{r, warning=FALSE, message=TRUE}
samo %>%
  sphere_shade(texture = "imhof3") %>% #texture makes reference to the color of the surface
  plot_3d(samo,
          zscale = 10,
          fov = 0, #default field of view angle
          theta = 50, #default rotation of the view
          zoom = 0.75,
          phi = 45, #default azimuth angle
          windowsize = c(800, 600)) #size of the pop-up window in pixels

Sys.sleep(1.0)
render_snapshot(clear=TRUE)
```

Now we can try adding water to the sea surface, using the function add_water().

```{r, warning=FALSE, message=TRUE}
samo %>%
  sphere_shade(texture = "imhof3") %>% 
  add_water(detect_water(samo), color = "lightblue") %>% #you can customize the color
  plot_3d(samo,
          zscale = 10,
          fov = 0, 
          theta = 50, 
          zoom = 0.75,
          phi = 45, 
          windowsize = c(800, 600)) 
Sys.sleep(1.0)
render_snapshot(clear=TRUE)
```

Now, we can add extra shadows in order for it to look more realistic. These will take a while to render.

```{r, warning=FALSE, message=TRUE}
samo %>%
  sphere_shade(texture = "imhof3") %>% 
  add_water(detect_water(samo), color = "lightblue") %>%
  add_shadow(ray_shade(samo), 0.5) %>% #generate fine-scale shades from sun
  add_shadow(ambient_shade(samo), 0) %>% #generate shades from atmospheric scattering
  plot_3d(samo,
          zscale = 10,
          fov = 0, 
          theta = 50, 
          zoom = 0.75,
          phi = 45, 
          windowsize = c(800, 600)) 
Sys.sleep(1.0)
render_snapshot(clear=FALSE)
```

We can add a few extra details on top of the rendered map. Like a scale bar, a compass, and a manual label. Remember to keep your pop-up window open.

```{r scalebar and compass, echo=TRUE, message=FALSE, warning=FALSE}
render_scalebar(limits=c(0, 5, 10, 15), #render a scalebar on top of the rendered map
                segments = 3, 
                label_unit = "km",
                position = "W")

render_compass(position = "E") #render a compass on top of the rendered map

render_label(samo,#render a label on top of the rendered map
             x = 160,
             y = 410,
             z = 7000,
             zscale = 50, #z scale magnification
             text = "Point Dume",
             textcolor = "darkred",
             linecolor = "darkred",
             textsize = 2, linewidth = 5)
Sys.sleep(1.0)
render_snapshot()
```

